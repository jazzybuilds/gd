XA.connector.mapsConnector=function(n,t){"use strict";var r={},e=[],i=[],u,o,s,f=[],h,c=[],a,l=!1;return o=function(n){switch(n.mode){case"Roadmap":return google.maps.MapTypeId.ROADMAP;case"Satellite":return google.maps.MapTypeId.SATELLITE;case"Hybrid":return google.maps.MapTypeId.HYBRID;default:return google.maps.MapTypeId.ROADMAP}},s=function(n,t){var i;return i=t.icon===null?new google.maps.Marker({position:new google.maps.LatLng(t.latitude,t.longitude),map:e[n],title:t.title}):new google.maps.Marker({position:new google.maps.LatLng(t.latitude,t.longitude),map:e[n],title:t.title,icon:t.icon}),t.latitude===""&&t.longitude===""&&i.setVisible(!1),i},h=function(n,t,r){t.id=r.id;i[n]?i[n].push({marker:t,type:r.type}):(i[n]=[],i[n].push({marker:t,type:r.type}))},r.loadScript=function(n,i){if(c.push(i),!l){l=!0;var r=t.createElement("script"),u="https://maps.googleapis.com/maps/api/js?v=3.exp";r.type="text/javascript";u+=typeof n!="undefined"&&n!==""?"&key="+n+"&v=3.exp&signed_in=false":"&signed_in=false";u+="&libraries=places&callback=XA.connector.mapsConnector.scriptsLoaded";r.src=u;r.onload=function(){console.log("Google loader has been loaded, waiting for maps api")};t.body.appendChild(r)}},r.scriptsLoaded=function(){for(var t=c.length,n=0;n<t;n++)c[n].call();l=!1},r.showMap=function(n,r,f){var s,h,c=r.disableMapZoomOnScroll!=="1",l=r.disableMapScrolling!=="1";f instanceof Array?(s={zoom:r.zoom,scrollwheel:c,draggable:l,center:new google.maps.LatLng(f[0],f[1]),mapTypeId:o(r)},u=new google.maps.Map(t.getElementById(r.canvasId),s)):(s={scrollwheel:c,draggable:l,mapTypeId:o(r)},u=new google.maps.Map(t.getElementById(r.canvasId),s),u.fitBounds(f),r.poiCount<2&&(h=google.maps.event.addListener(u,"idle",function(){i.length>0&&i[n].length<2&&(u.setZoom(r.zoom),google.maps.event.removeListener(h))})));h=google.maps.event.addListener(u,"zoom_changed",function(){var n=u.getZoom();n<1&&u.setZoom(1)});e[n]=u},r.renderPoi=function(n,t){var r=s(n,t),i=n+"#"+t.id;h(n,r,t);t.html!==""&&t.html!==null&&(f[i]=new google.maps.InfoWindow({content:t.html}));typeof f[i]!="undefined"&&function(t,i){google.maps.event.addListener(i,"click",function(){for(var r in f)f.hasOwnProperty(r)&&f[r].close();f[t].open(e[n],i)})}(i,r)},r.renderDynamicPoi=function(n,t,i){var r=s(n,t);h(n,r,t);google.maps.event.addListener(r,"click",function(){if(typeof i=="function"){var o=t.id,s=t.poiTypeId,u=t.poiVariantId;if(u==null)return;i(o,s,u,function(t){f[n]&&f[n].close();f[n]=new google.maps.InfoWindow({content:t.Html});f[n].open(e[n],r)})}})},r.clearMarkers=function(n){var t,r;if(i.hasOwnProperty(n)){for(t=i[n],r=0;r<t.length;r++)t[r].type==="Dynamic"&&t[r].marker.setMap(null);i[n]=t.filter(function(n){return n.type==="Static"||n.type==="MyLocation"?!0:!1})}},r.updateMapPosition=function(n){var o=e[n],r,u=[],f=new google.maps.LatLngBounds,t;for(i.hasOwnProperty(n)&&(u=i[n]),t=0;t<u.length;t++)r=u[t].marker,f.extend(new google.maps.LatLng(r.position.lat(),r.position.lng()));o.fitBounds(f)},r.centerMap=function(n,t,r,u){var h=e[n],o=[],s,f;if(r&&h.setCenter(new google.maps.LatLng(t.coordinates[0],t.coordinates[1])),u){for(i.hasOwnProperty(n)&&(o=i[n]),f=0;f<o.length;f++)o[f].marker.setAnimation(null),o[f].marker.id===t.id&&(s=o[f].marker,o[f].marker.setMap(null));typeof s!="undefined"&&(s.setMap(h),s.setAnimation(google.maps.Animation.BOUNCE),a=setTimeout(function(){s.setMap(h)},2e3))}},r.getCentralPoint=function(n){for(var t,u=n.length,r=new google.maps.LatLngBounds,i=0;i<u;i++)t=n[i],t.latitude!==""&&t.longitude!==""&&r.extend(new google.maps.LatLng(t.latitude,t.longitude));return r},r.locationAutocomplete=function(n,t,i){var u=new google.maps.places.AutocompleteService,r=n.maxResults<=0?1:n.maxResults;u.getQueryPredictions({input:n.text},function(n){var f=[],e,u;if(n!=null&&n.length){for(e=n.length>=r?r:n.length,u=0;u<e;u++)f.push(_.extend(n[u],{text:n[u].description}));t(f)}else i()})},r.addressLookup=function(n,i,r){var f,e;n.hasOwnProperty("place_id")?(f=new google.maps.places.PlacesService(typeof u!="undefined"?u:new google.maps.Map(t.createElement("div"))),f.getDetails({placeId:n.place_id},function(n,t){if(t==google.maps.places.PlacesServiceStatus.OK&&typeof n!="undefined"&&typeof n.geometry.location!="undefined"){i([n.geometry.location.lat(),n.geometry.location.lng()]);return}r()})):(e={address:n.text},f=new google.maps.Geocoder,f.geocode(e,function(n,t){if(t==google.maps.GeocoderStatus.OK&&typeof n[0]!="undefined"&&typeof n[0].geometry.location!="undefined"){i([n[0].geometry.location.lat(),n[0].geometry.location.lng()]);return}r()}))},r.updateMyPoiLocation=function(n,t,r){var o=e[n],f=[],u;i.hasOwnProperty(n)&&(f=i[n],u=f.filter(function(n){return n.type==="MyLocation"?!0:!1}),u.length>0&&(u[0].marker.setPosition(new google.maps.LatLng(t[0],t[1])),u[0].marker.setVisible(!0),this.updateMapPosition(n),typeof r!="undefined"&&o.setZoom(r)))},r}(jQuery,document)

XA.component.locationService=function(){"use strict";var u={},f,e,o,n=!1,t=[],i=[],r;return f=function(u,f){var o;(t.push(f),i.push(u),n)||(n=!0,navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){for(o=0;o<i.length;o++)i[o]([t.coords.latitude,t.coords.longitude]);n=!1},function(){r("Error while detecting user location location");n=!1},e()):(r("Your browser doesn't support geolocation"),n=!1))},e=function(){var n=o();return n.indexOf("Chrome")!==-1?{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}:{timeout:1e3,maximumAge:Infinity}},o=function(){var i=navigator.userAgent,t,n=i.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(i)||[],"IE "+(t[1]||"")):n[1]==="Chrome"&&(t=i.match(/\b(OPR|Edge)\/(\d+)/),t!=null)?t.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],(t=i.match(/version\/(\d+)/i))!=null&&n.splice(1,1,t[1]),n.join(" "))},r=function(n){for(var i=0;i<t.length;i++)typeof t[i]=="function"&&t[i](n)},u.detectLocation=function(n,t){f(n,t)},u}(jQuery,document);XA.register("locationService",XA.component.locationService);XA.component.map=function(n,t){"use strict";var r={},e=[],a,v=[],y,o,s,u,i,p=!1,h,c,l,w,b,f,k=[],d,g;return w=function(n){c=n},b=function(n){f=n},h=function(){for(var t=e.length,n=0;n<t;n++)k.push(new g({el:e[n],model:new d}));typeof XA.component.search!="undefined"&&l()},l=function(){var n,t=typeof c!="undefined",i=typeof f!="undefined";(t||i)&&(n=k.filter(function(n){return n.model.get("showed")===!1?!0:!1}),n.length>0?setTimeout(l,1e3):(t&&XA.component.search.vent.trigger("internal-results-loaded",c),i&&XA.component.search.vent.trigger("internal-my-location-coordinates-changed",f)))},d=Backbone.Model.extend({defaults:{dataProperties:{},dynamicPoiList:[],showed:!1,myLocation:["",""],id:null,loadMore:!1},initialize:function(){var n=this.get("dataProperties").searchResultsSignature,t=u.parseHashParameters(window.location.hash),i=typeof n!="undefined"&&n!==""?n+"_g":"g";if(typeof XA.component.search!="undefined"){XA.component.search.vent.on("results-loaded",this.updateDynamicPoiList.bind(this));XA.component.search.vent.on("internal-results-loaded",this.updateDynamicPoiList.bind(this));XA.component.search.vent.on("my-location-coordinates-changed",this.changeMyLocation.bind(this));XA.component.search.vent.on("internal-my-location-coordinates-changed",this.changeMyLocation.bind(this));XA.component.search.vent.on("hashChanged",this.hashChanged.bind(this))}t.hasOwnProperty(i)&&t[i]!==""&&this.set("myLocation",t[i].split("|"))},getPoiVariant:function(n,t){var r=this.get("dataProperties").typeToVariantMapping,i;return typeof n!="undefined"&&n!=null?(i="{"+n.toUpperCase()+"}",r.hasOwnProperty(i)?r[i]:t):t},updateDynamicPoiList:function(n){var r=[],f=this.get("dataProperties").searchResultsSignature,u=n.data.filter(function(n){return n.hasOwnProperty("Geospatial")?!0:!1}),i,t;if(f===n.searchResultsSignature){for(this.set("loadMore",n.loadMore),i=0;i<u.length;i++)(t=u[i],t.Geospatial.Latitude!==0&&t.Geospatial.Longitude!==0)&&r.push({id:t.Id,type:"Dynamic",title:t.Name,latitude:t.Geospatial.Latitude,longitude:t.Geospatial.Longitude,icon:t.Geospatial.PoiIcon,poiTypeId:t.Geospatial.PoiTypeId,poiVariantId:this.getPoiVariant(t.Geospatial.PoiTypeId,t.Geospatial.PoiVariantId)});this.set("dynamicPoiList",r)}},changeMyLocation:function(n){var t=this.get("dataProperties").searchResultsSignature;t===n.sig&&this.set("myLocation",n.coordinates)},hashChanged:function(n){var r=this.get("dataProperties").searchResultsSignature,t=n[r!==""?r+"_g":"g"],i;r===f.sig&&typeof t!="undefined"&&t!==null&&t!==""&&(i=t.split("|"),i.length>1&&this.set("myLocation",[i[0],i[1]]))}}),g=Backbone.View.extend({initialize:function(){var n=this.$el.data(),t=n.properties;this.model&&(this.model.set({dataProperties:t}),this.model.set({id:this.$el.find(".map-canvas").prop("id")}));this.render();this.model.on("change:dynamicPoiList",this.renderDynamicPois,this);this.model.on("change:myLocation",this.updateMyLocationPoi,this);if(typeof XA.component.search!="undefined")XA.component.search.vent.on("center-map",this.handleCenterMap.bind(this));this.updateMyLocationPoi()},render:function(){var u=this,n=this.model.get("showed"),r=t.getElementById(this.model.get("id"));n||r===null||this.getCentralPoint(function(n,t){if(typeof n!="undefined"){var u=typeof t!="undefined"?t:this,f=u.model.get("id"),r=u.model.get("dataProperties"),e={canvasId:f,zoom:typeof r.zoom=="number"?r.zoom:u.parseZoom(r.zoom,15),mode:r.mode,poiCount:r.pois.length,key:r.key,disableMapScrolling:r.disableMapScrolling,disableMapZoomOnScroll:r.disableMapZoomOnScroll};i.showMap(f,e,n);u.renderPoiList(f,r.pois);u.model.set("showed",!0)}})},renderDynamicPois:function(){var u=this.model.get("dataProperties"),t=this.model.get("dynamicPoiList"),f=this.model.get("dataProperties"),r=this.model.get("id"),n;for(this.model.get("loadMore")||i.clearMarkers(r),n=0;n<t.length;n++)i.renderDynamicPoi(r,t[n],this.getGeoPoiContent.bind(this));u.centralPointMode==="MidOfPoi"&&i.updateMapPosition(this.model.get("id"),this.parseZoom(f.zoom,15))},renderPoiList:function(n,t){for(var r,s,c=t.length,l=this.model.get("dataProperties"),h=l.searchResultsSignature,f=u.parseHashParameters(window.location.hash),e=h!==""?h+"_g":"g",o=0;o<c;o++){if(r=t[o],r.Type==="MyLocation")s=this.model.get("myLocation"),r.Latitude=s[0],r.Longitude=s[1],!f.hasOwnProperty(e)||f.hasOwnProperty(e)&&f[e]===""?this.getCurrentPosition(function(n){this.model.set("myLocation",n)}):f.hasOwnProperty(e)&&this.model.set("myLocation",f[e].split("|"));else if(r.Latitude===""||r.Longitude==="")continue;i.renderPoi(n,{id:r.Id.Guid,title:r.Title,description:r.Description,latitude:r.Latitude,longitude:r.Longitude,icon:r.PoiIcon,html:r.Html,type:r.Type})}},getPoiContent:function(n,t,i,r){var u=this.model.get("dataProperties"),f=o.createGetPoiContentUrl({endpoint:u.variantsEndpoint},n,i);s.getData({callback:r,url:f,excludeSiteName:!0})},getGeoPoiContent:function(n,t,i,r){var f=this.model.get("myLocation"),e=f[0],h=f[1],c=this.model.get("dataProperties"),l=u.parseHashParameters(window.location.hash),a=l.o,v=o.createGetGeoPoiContentUrl({endpoint:c.variantsEndpoint},n,i,e+","+h,a);s.getData({callback:r,url:v,excludeSiteName:!0})},getCentralPoint:function(n){var t=this.model.get("dataProperties"),i=this;switch(t.centralPointMode){case"Auto":t.centralPoint!==""?n.call(i,[t.latitude,t.longitude]):t.pois.length>0?n.call(i,[t.pois[0].Latitude,t.pois[0].Longitude]):this.getCurrentPosition(n);break;case"MidOfPoi":n.call(i,this.getPoisCentralPoint());break;case"Location":this.getCurrentPosition(n)}},getCurrentPosition:function(n){var t=this;XA.component.locationService.detectLocation(function(i){n.call(t,i,t)},function(i){n.call(t,[0,0],t);console.log(i)})},getPoisCentralPoint:function(){for(var n,u=[],r=this.model.get("myLocation"),f=this.model.get("dataProperties"),e=f.pois.length,t=0;t<e;t++)n=f.pois[t],n.TemplateId.Guid==="7dd9ece5-9461-498d-8721-7cbea8111b5e"?r[0]!==""&&r[1]!==""&&(n.Latitude=r[0],n.Longitude=r[1],this.model.set("dataProperties",f),u.push({latitude:n.Latitude,longitude:n.Longitude})):u.push({latitude:n.Latitude,longitude:n.Longitude});return i.getCentralPoint(u)},handleCenterMap:function(n){var t=this.model.get("dataProperties").centerOnFoundPoi==="1",i=this.model.get("dataProperties").animateFoundPoi==="1";this.centerOnMap(n,t,i)},centerOnMap:function(n,t,r){n.sig===this.model.get("dataProperties").searchResultsSignature&&i.centerMap(this.model.get("id"),n,t,r)},updateMyLocationPoi:function(){var n=this.model.get("dataProperties"),r=this.model.get("myLocation"),t;r[0]!==""&&r[1]!==0?i.updateMyPoiLocation(this.model.get("id"),r,this.parseZoom(n.zoom,15)):n.latitude!==""&&n.longitude!==""&&(t={},t.sig=n.searchResultsSignature,t.coordinates=[n.latitude,n.longitude],this.centerOnMap(t,!0,!1))},parseZoom:function(n,t){var i=t;return n!==null&&n.length>0&&(isNaN(n)||(i=parseInt(n))),i}}),r.init=function(){var t,c=n(".map.component:not(.initialized)"),l=c.length,r,f;if(typeof XA.component.search!="undefined"){u=XA.component.search.query;o=XA.component.search.url;s=XA.component.search.ajax;XA.component.search.vent.on("results-loaded",w);XA.component.search.vent.on("my-location-coordinates-changed",b)}if(i=XA.connector.mapsConnector,l>0){for(t=0;t<l;t++)r=n(c[t]),f=r.data("properties"),y=f.key,a=f.endpoint,v.push(f.searchResultsSignature),r.addClass("initialized"),e.push(r);p?h():i.loadScript(y,XA.component.map.scriptsLoaded)}},r.scriptsLoaded=function(){console.log("Maps api loaded");p=!0;h()},r.getSearchEndpoint=function(){return a},r.getSignatures=function(){return v},r}(jQuery,document);XA.register("map",XA.component.map)